# LGDXRobot Cloud GitLab CI/CD
# Variables Needed
# $EXT_REGISTRY: Registry URL (e.g. docker.io)
# $EXT_USER: Username for the registry
# $EXT_PAT: PAT for the registry (https://docs.docker.com/security/for-developers/access-tokens/)

variables:
  SUPPORT_IMAGE_TAG_ARM64: $CI_REGISTRY_IMAGE/arm64support:latest
  SUPPORT_IMAGE_TAG_AMD64: $CI_REGISTRY_IMAGE/amd64support:latest

stages:
  - build-sup
  - build
  - release

build-sup-amd64:
  stage: build-sup
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual
  image: docker:24.0.5-git
  tags:
    - lgdx-amd64
  services:
    - docker:24.0.5-dind
  script:
    - echo -n $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker build -f Dockerfile.amd64sup -t $SUPPORT_IMAGE_TAG_AMD64 .
    - docker push $SUPPORT_IMAGE_TAG_AMD64

build-sup-arm64:
  stage: build-sup
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual
  image: docker:24.0.5-git
  tags:
    - lgdx-arm64
    - saas-linux-small-arm64 
  services:
    - docker:24.0.5-dind
  script:
    - echo -n $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker build -f Dockerfile.arm64sup -t $SUPPORT_IMAGE_TAG_ARM64 .
    - docker push $SUPPORT_IMAGE_TAG_ARM64

build-amd64:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: docker:24.0.5-git
  tags:
    - lgdx-amd64
  services:
    - docker:24.0.5-dind
  script:
    - echo -n $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker pull $SUPPORT_IMAGE_TAG_AMD64
    - echo -n $EXT_PAT | docker login -u $EXT_USER --password-stdin $EXT_REGISTRY
    - docker build -t $EXT_REGISTRY/$EXT_USER/lgdxrobot2:dev-amd64 -f Dockerfile.amd64 .
    - docker push $EXT_REGISTRY/$EXT_USER/lgdxrobot2:dev-amd64
    
build-arm64:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: docker:24.0.5-git
  tags:
    - saas-linux-small-arm64 
    - lgdx-arm64
  services:
    - docker:24.0.5-dind
  script:
    - echo -n $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker pull $SUPPORT_IMAGE_TAG_ARM64
    - echo -n $EXT_PAT | docker login -u $EXT_USER --password-stdin $EXT_REGISTRY
    - docker build -t $EXT_REGISTRY/$EXT_USER/lgdxrobot2:dev-arm64 -f Dockerfile.arm64 .
    - docker push $EXT_REGISTRY/$EXT_USER/lgdxrobot2:dev-arm64
    
release_job:
  stage: release
  image: docker:24.0.5-git
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  tags:
    - lgdx-amd64
    - lgdx-arm64
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add glab
    - apk add gitlab-release-cli
    - apk add libxml2-utils
    - export APP_VERSION=$(xmllint --xpath "//package/version/text()" lgdxrobot2/package.xml)
  script:
    - echo -n $EXT_PAT | docker login -u $EXT_USER --password-stdin $EXT_REGISTRY
    - docker manifest create $EXT_REGISTRY/$EXT_USER/lgdxrobot2:latest --amend lgdxrobot2:dev-amd64 --amend lgdxrobot2:dev-arm64
    - docker manifest create $EXT_REGISTRY/$EXT_USER/lgdxrobot2:$APP_VERSION --amend lgdxrobot2:dev-amd64 --amend lgdxrobot2:dev-arm64
    - docker manifest push $EXT_REGISTRY/$EXT_USER/lgdxrobot2:latest
    - docker manifest push $EXT_REGISTRY/$EXT_USER/lgdxrobot2:$APP_VERSION
  release:
    name : 'Release $APP_VERSION'
    tag_name: '$APP_VERSION'
    description: '$APP_VERSION'
    ref: '$CI_COMMIT_SHA'
    assets:
      links:
        - name: 'Docker Images for LGDXRobot2'
          url: 'https://hub.docker.com/v2/repositories/yukaitung/lgdxrobot2/tags/$APP_VERSION'


